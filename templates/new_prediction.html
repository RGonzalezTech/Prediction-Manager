{% extends "layout.html" %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">New Prediction</h1>
    <a href="/" class="text-blue-500">Back to Dashboard</a>
</div>

<form id="new-prediction-form" class="space-y-4">
    <div>
        <label for="creator" class="block font-bold">Who is betting?</label>
        <select id="creator" name="creator_id" class="w-full p-2 border rounded">
            <!-- Options will be loaded here -->
        </select>
    </div>

    <div>
        <label for="description" class="block font-bold">Description</label>
        <textarea id="description" name="description" class="w-full p-2 border rounded"></textarea>
    </div>

    <div>
        <label for="category" class="block font-bold">Category</label>
        <select id="category" name="category_id" class="w-full p-2 border rounded">
            <!-- Options will be loaded here -->
        </select>
    </div>

    <div>
        <label for="confidence" class="block font-bold">Confidence</label>
        <input type="range" id="confidence" name="confidence" min="0.01" max="0.99" step="0.001" class="w-full">
        <div id="confidence-feedback" class="text-center"></div>
    </div>

    <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded">Create Prediction</button>
</form>

<script>
    const confidenceSlider = document.getElementById('confidence');
    const confidenceFeedback = document.getElementById('confidence-feedback');
    const snapPoints = [
        0.01, 0.02, 0.05, 0.1, 0.2, 0.25, 1/3, 0.5,
        2/3, 0.75, 0.8, 0.9, 0.95, 0.98, 0.99
    ];

    function findClosest(value, points) {
        return points.reduce((prev, curr) => {
            return (Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev);
        });
    }

    function updateConfidenceFeedback() {
        const confidence = parseFloat(confidenceSlider.value);
        const percentage = (confidence * 100).toFixed(0);
        let oddsText;
        if (confidence >= 0.5) {
            const oddsRatio = confidence / (1 - confidence);
            if (Math.round(oddsRatio) === oddsRatio) {
                oddsText = `You are risking ${oddsRatio.toFixed(0)} units to win 1.0 unit (${oddsRatio.toFixed(0)}:1 odds).`;
            } else {
                oddsText = `You are risking ${oddsRatio.toFixed(1)} units to win 1.0 unit.`;
            }
        } else {
            const oddsRatio = (1 - confidence) / confidence;
            if (Math.round(oddsRatio) === oddsRatio) {
                oddsText = `You are risking 1.0 unit to win ${oddsRatio.toFixed(0)} units (1:${oddsRatio.toFixed(0)} odds).`;
            } else {
                oddsText = `You are risking 1.0 unit to win ${oddsRatio.toFixed(1)} units.`;
            }
        }
        confidenceFeedback.textContent = `You are ${percentage}% confident. ${oddsText}`;
    }

    confidenceSlider.addEventListener('input', updateConfidenceFeedback);

    confidenceSlider.addEventListener('change', () => {
        const value = parseFloat(confidenceSlider.value);
        const closest = findClosest(value, snapPoints);
        confidenceSlider.value = closest;
        updateConfidenceFeedback();
    });

    updateConfidenceFeedback();

    async function fetchUsers() {
        const response = await fetch('/api/users');
        const users = await response.json();
        const select = document.getElementById('creator');
        for (const user of users) {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name;
            select.appendChild(option);
        }
    }

    async function fetchCategories() {
        const response = await fetch('/api/categories');
        const categories = await response.json();
        const select = document.getElementById('category');
        for (const category of categories) {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        }
    }

    const form = document.getElementById('new-prediction-form');
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.confidence = parseFloat(data.confidence);
        data.creator_id = parseInt(data.creator_id);
        data.category_id = parseInt(data.category_id);

        const response = await fetch('/api/predictions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            window.location.href = '/';
        } else {
            alert('Failed to create prediction');
        }
    });

    fetchUsers();
    fetchCategories();
</script>
{% endblock %}